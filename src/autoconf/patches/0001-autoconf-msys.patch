From ecc5954689b2dc66aa243f290d6ae2273f3d0819 Mon Sep 17 00:00:00 2001
From: Hiroshi Shirosaki <h.shirosaki@gmail.com>
Date: Fri, 27 Jun 2014 01:53:10 +0900
Subject: [PATCH] autoconf-msys

The patches in the source file.
http://sourceforge.net/projects/mingw/files/MSYS/msysdev/autoconf/autoconf-2.68-1/autoconf-2.68-1-msys-1.0.17-src.tar.lzma/download
---
 bin/autom4te.in        | 20 +++++++++++++++++---
 build-aux/config.guess |  3 +++
 lib/Autom4te/C4che.pm  | 14 +++++++++++++-
 lib/m4sugar/m4sh.m4    |  2 +-
 4 files changed, 34 insertions(+), 5 deletions(-)

diff --git a/bin/autom4te.in b/bin/autom4te.in
index 11773c9..225161f 100644
--- a/bin/autom4te.in
+++ b/bin/autom4te.in
@@ -544,13 +544,21 @@ sub handle_output ($$)
   # stdout is to be handled by hand :(.  Don't use fdopen as it means
   # we will close STDOUT, which we already do in END.
   my $out = new Autom4te::XFile;
-  if ($output eq '-')
+  my $atomic_replace;
+  if ($output eq '-' || (-e $output && ! -f $output))
     {
       $out->open (">$output");
+      $atomic_replace = 0;
     }
   else
     {
-      $out->open($output, O_CREAT | O_WRONLY | O_TRUNC, oct ($mode));
+      $out->open("$output.tmp", O_CREAT | O_WRONLY | O_TRUNC, oct ($mode));
+      if ($out) {
+        $atomic_replace = 1;
+      } else {
+        $out->open($output, O_CREAT | O_WRONLY | O_TRUNC, oct ($mode));
+        $atomic_replace = 0;
+      }
     }
   fatal "cannot create $output: $!"
     unless $out;
@@ -589,6 +597,11 @@ sub handle_output ($$)
 
   $out->close();
 
+  if ($atomic_replace && !rename("$output.tmp", "$output")) {
+    move ("${output}.tmp", "$output")
+      or fatal "cannot rename ${output}.tmp as $output: $!";
+  }
+
   # If no forbidden words, we're done.
   return
     if ! %prohibited;
@@ -987,7 +1000,8 @@ $icache_file->lock (LOCK_EX)
 # If autom4te is younger, then some structures such as C4che might
 # have changed, which would corrupt its processing.
 Autom4te::C4che->load ($icache_file)
-  if -f $icache && mtime ($icache) > mtime ($0);
+  if -f $icache && mtime ($icache) > mtime ($0)
+                && Autom4te::C4che->good_version ($icache_file);
 
 # Add the new trace requests.
 my $req = Autom4te::C4che->request ('input' => \@ARGV,
diff --git a/build-aux/config.guess b/build-aux/config.guess
index d622a44..b2fa127 100644
--- a/build-aux/config.guess
+++ b/build-aux/config.guess
@@ -807,6 +807,9 @@ EOF
     i*:MSYS*:*)
 	echo ${UNAME_MACHINE}-pc-msys
 	exit ;;
+    i*:MSYS*:*)
+	echo ${UNAME_MACHINE}-pc-msys
+	exit ;;
     i*:windows32*:*)
 	# uname -m includes "-pc" on this system.
 	echo ${UNAME_MACHINE}-mingw32
diff --git a/lib/Autom4te/C4che.pm b/lib/Autom4te/C4che.pm
index b91a5e8..3411707 100644
--- a/lib/Autom4te/C4che.pm
+++ b/lib/Autom4te/C4che.pm
@@ -35,6 +35,8 @@ use Autom4te::Request;
 use Carp;
 use strict;
 
+my $VERSION = 'Mon Aug  2 13:04:52 PDT 2010';
+
 =over 4
 
 =item @request
@@ -180,7 +182,7 @@ sub save ($$)
   $file->seek (0, 0);
   $file->truncate (0);
   print $file
-    "# This file was generated.\n",
+    "# This file was generated by Autom4te $VERSION.\n",
     "# It contains the lists of macros which have been traced.\n",
     "# It can be safely removed.\n",
     "\n",
@@ -194,6 +196,16 @@ Load the cache from the C<$file> file object.
 
 =cut
 
+#
+# GOOD_VERSION ($FILE)
+sub good_version ($$)
+{
+  my ($self, $file) = @_;
+  my ($line) = $file->getline;
+
+  return defined ($line) && scalar ($line =~ / $VERSION.$/);
+}
+
 # LOAD ($FILE)
 # ------------
 sub load ($$)
diff --git a/lib/m4sugar/m4sh.m4 b/lib/m4sugar/m4sh.m4
index f05346b..80e7376 100644
--- a/lib/m4sugar/m4sh.m4
+++ b/lib/m4sugar/m4sh.m4
@@ -884,7 +884,7 @@ m4_defun_init([AS_ERROR],
 [m4_append_uniq([_AS_CLEANUP],
   [m4_divert_text([M4SH-INIT-FN], [_AS_ERROR_PREPARE[]])])],
 [as_fn_error m4_default([$2], [$?]) "_AS_QUOTE([$1])"m4_ifval(AS_MESSAGE_LOG_FD,
-  [ "$LINENO" AS_MESSAGE_LOG_FD])])
+  [ "$LINENO" AS_MESSAGE_LOG_FD ])])
 
 
 # AS_LINENO_PUSH([LINENO])
-- 
1.9.4.msysgit.0

