From daad9123ef283ca0b24776820ecd022a125c61ae Mon Sep 17 00:00:00 2001
From: Hiroshi Shirosaki <h.shirosaki@gmail.com>
Date: Tue, 1 Jul 2014 00:40:55 +0900
Subject: [PATCH 05/43] 4.7-execstack

https://github.com/Alexpux/MSYS2-packages/blob/master/gcc/4.7-execstack.patch
---
 gcc/config/i386/cygming.opt | 4 ++++
 gcc/config/i386/cygwin.h    | 4 ++++
 gcc/config/i386/mingw.opt   | 4 ----
 libgcc/config.host          | 3 +++
 4 files changed, 11 insertions(+), 4 deletions(-)

diff --git a/gcc/config/i386/cygming.opt b/gcc/config/i386/cygming.opt
index 01fa0b6..32e44c9 100644
--- a/gcc/config/i386/cygming.opt
+++ b/gcc/config/i386/cygming.opt
@@ -50,6 +50,10 @@ muse-libstdc-wrappers
 Target Condition({defined (USE_CYGWIN_LIBSTDCXX_WRAPPERS)})
 Compile code that relies on Cygwin DLL wrappers to support C++ operator new/delete replacement
 
+fset-stack-executable
+Common Report Var(flag_setstackexecutable) Init(1) Optimization
+For nested functions on stack executable permission is set.
+
 posix
 Driver
 
diff --git a/gcc/config/i386/cygwin.h b/gcc/config/i386/cygwin.h
index 7f92ada..fefbb19 100644
--- a/gcc/config/i386/cygwin.h
+++ b/gcc/config/i386/cygwin.h
@@ -135,3 +135,7 @@ along with GCC; see the file COPYING3.  If not see
 /* We should find a way to not have to update this manually.  */
 #define LIBGCJ_SONAME "cyggcj" /*LIBGCC_EH_EXTN*/ "-13.dll"
 
+/* Make stack executable to avoid DEP problems with trampolines.  */
+#define HAVE_ENABLE_EXECUTE_STACK
+#undef  CHECK_EXECUTE_STACK_ENABLED
+#define CHECK_EXECUTE_STACK_ENABLED flag_setstackexecutable
diff --git a/gcc/config/i386/mingw.opt b/gcc/config/i386/mingw.opt
index 0341904..85ed5be 100644
--- a/gcc/config/i386/mingw.opt
+++ b/gcc/config/i386/mingw.opt
@@ -28,8 +28,4 @@ Wpedantic-ms-format
 C ObjC C++ ObjC++ Var(warn_pedantic_ms_format) Init(1) Warning
 Warn about none ISO msvcrt scanf/printf width extensions
 
-fset-stack-executable
-Common Report Var(flag_setstackexecutable) Init(1) Optimization
-For nested functions on stack executable permission is set.
-
 ; Need to retain blank line above.
diff --git a/libgcc/config.host b/libgcc/config.host
index 4a76998..f503642 100644
--- a/libgcc/config.host
+++ b/libgcc/config.host
@@ -274,6 +274,9 @@ case ${host} in
 i[34567]86-*-mingw* | x86_64-*-mingw*)
   enable_execute_stack=config/i386/enable-execute-stack-mingw32.c
   ;;
+i[34567]86-*-cygwin* | x86_64-*-cygwin*)
+  enable_execute_stack=config/i386/enable-execute-stack-mingw32.c
+  ;;
 *)
   enable_execute_stack=enable-execute-stack-empty.c;
   ;;
-- 
2.0.0.msysgit.0

